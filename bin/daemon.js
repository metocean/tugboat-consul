// Generated by CoffeeScript 1.8.0
var consul, consulhost, error, host, http, key, launch, os, parse_url, path, tug, url;

consul = require('redwire-consul');

tug = require('tugboat');

os = require('os');

http = require('http');

parse_url = require('url').parse;

host = os.hostname();

if (process.env.TUGBOAT_HOST != null) {
  host = process.env.TUGBOAT_HOST;
}

consulhost = 'http://127.0.0.1:8500';

if (process.env.CONSUL_HOST != null) {
  consulhost = process.env.CONSUL_HOST;
}

if (consulhost.indexOf('http://') !== 0) {
  consulhost = "http://" + consulhost;
}

key = "tugboat/" + host + "/";

path = "/v1/kv/" + key;

url = "" + consulhost + path + "?keys";

launch = function() {
  new consul.Watch(url, function(groups) {
    groups = groups.map(function(g) {
      return g.substr(key.length);
    }).filter(function(g) {
      if (g.length === 0) {
        return false;
      }
      if (g.indexOf('/') !== -1) {
        return false;
      }
      return true;
    });
    return console.log(groups);
  });
  return console.log("Tugboat Consul is running for host " + host + "...");
};

error = function(e) {
  console.error(e);
  return process.exit(-1);
};

http.get(url, function(res) {
  var params, req;
  if (res.statusCode !== 404) {
    return launch();
  }
  params = parse_url(consulhost);
  params.path = path;
  params.method = 'PUT';
  req = http.request(params, function(res) {
    return launch();
  }).on('error', error);
  return req.end();
}).on('error', error);
